See companion [discussion](https://github.com/wjakob/nanobind/discussions/791) in the nanobind repository.

# Study nanobind slow Build Times on Windows with Optimization flags

I noticed extremely slow build times on Windows (more than 3 hours!) when using any optimization switch (/Os, /O1, or /O2). However, builds are much faster when using /Od (no optimization), completing in under 2 minutes.

This minimal reproduction repository purpose is to analyze build times and library sizes for medium-sized projects (~8,300 lines of binding code) generated by [litgen](https://github.com/pthom/litgen) for both Pybind11 and Nanobind.

You can find detailed results in its [GitHub Actions workflows](https://github.com/pthom/nano_study_link/actions)

#### Results Overview

Here are the build times and library sizes for both Pybind11 and Nanobind across platforms:

_When using Pybind11_

| Platform | Lib Size (MB) | Options  | Time   |
|----------|---------------:|----------|--------|
| linux    |            4.9 | default  | 3m 21s |
| macos    |            4.0 | default  | 3m 17s |
| windows  |            3.2 | default  | 3m 02s |

_When using Nanobind_

| Platform | Lib Size (MB) | Options                               | Time       |
|----------|---------------:|---------------------------------------|------------|
| linux    |            2.6 | default (will use -Os)                | 1m 37s     |
| macos    |            2.2 | default (will use -Os)                | 1m 5s      |
| linux    |            2.8 | -O3                                   | 1m 43s     |
| macos    |            2.3 | -O3                                   | 1m 1s      |
| windows  |            5.3 | no optim                              | 1m 59s     |
| windows  |            2.2 | default optim (/Os cf nanobind cmake) | 2h 28m (!) |
| windows  |            2.2 | /O1 (close to /Os)                    | 2h 18m (!) |
| windows  |            2.2 | /Os (optim size)                      | 2h 22m (!) |



### Quick Analysis (on this particular project)

#### On Linux and macOS

* Nanobind consistently outperforms Pybind11 in build times and produces smaller binaries
* Optimization switches (`-O3` vs `-Os`) have a minor impact on build times and binary sizes

#### On Windows
- On Windows, build times with Nanobind are prohibitively slow under optimization switches (/Os, /O1, /O2), taking over 2 hours, compared to under 2 minutes with /Od (no optimization).
- Library sizes are significantly smaller with optimization switches, but the difference may depend on the codebase (see analysis below with a more comprehensive project).


#### Reproduction repository summary

Here is a summarized version of the repository structure:
```
nano_study_link/
├── CMakeLists.txt          # CMakelists with switches for optims 
├── imgui/                  # imgui source code
│         ├── imconfig.h  
│         ├── imgui.cpp
│         ├── imgui.h
│         └── ...
├── nanobind/               # nanobind submodule
├── pybind11/               # pybind11 submodule
├── nanobind_imgui.cpp      # imgui bindings with nanobind (generated by litgen) 8300 lines
├── pybind11_imgui.cpp      # imgui bindings with pybind11 (generated by litgen) 8300 lines
├── pyproject.toml
├──.github/
        └── workflows/ # CI workflows (to analyze build times and library size
           ├── pip_nixes_nano.yml              # Linux and macOS (Nanobind default)
           ├── pip_nixes_nano_o3.yml           # Linux and macOS with -O3
           ├── pip_nixes_pybind.yml            # Linux and macOS (Pybind11 default)
           ├── pip_win_nano_optim.yml          # Windows with Nanobind default (/Os)
           ├── pip_win_nano_optim_disabled.yml # Windows with /Od (no optimization)
           ├── pip_win_nano_optim_o1.yml       # Windows with /O1 optimization
           ├── pip_win_nano_optim_o2.yml       # Windows with /O2 optimization
           ├── pip_win_nano_optim_size.yml     # Windows with /Os optimization
           └── pip_win_pybind.yml              # Windows with Pybind11 default            
```

